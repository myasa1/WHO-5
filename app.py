import streamlit as st
import numpy as np
from sklearn.ensemble import RandomForestClassifier

# ----------------------------
# 1ï¸âƒ£ ØªØ¯Ø±ÙŠØ¨ Ù†Ù…ÙˆØ°Ø¬ ØªØ¹Ù„Ù… Ø¢Ù„Ø©
# ----------------------------
@st.cache_data
def train_model():
    np.random.seed(42)
    n = 2500

    Q = np.random.randint(0, 6, (n, 5))
    sleep = np.random.randint(4, 11, n)
    activity = np.random.randint(1, 6, n)

    total = Q.sum(axis=1)

    risk = []
    for t in total:
        if t <= 10:
            risk.append(2)  # Ù…Ø±ØªÙØ¹
        elif t <= 17:
            risk.append(1)  # Ù…ØªÙˆØ³Ø·
        else:
            risk.append(0)  # Ù…Ù†Ø®ÙØ¶

    X = np.column_stack((Q, sleep, activity))
    y = np.array(risk)

    model = RandomForestClassifier(n_estimators=200, random_state=42)
    model.fit(X, y)

    return model

model = train_model()

# ----------------------------
# 2ï¸âƒ£ Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ
# ----------------------------
def generate_plan(q1, q2, q3, q4, q5, sleep, activity, prediction):

    total = q1 + q2 + q3 + q4 + q5
    plan = "## ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ÙØ³ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠ\n\n"

    if prediction == 2:
        severity_text = "ğŸ”´ Ù…Ø³ØªÙˆÙ‰ Ø®Ø·ÙˆØ±Ø© Ù…Ø±ØªÙØ¹"
        intro = "ØªØ´ÙŠØ± Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø¥Ù„Ù‰ Ø§Ù†Ø®ÙØ§Ø¶ Ù…Ù„Ø­ÙˆØ¸ ÙÙŠ Ø§Ù„Ø±ÙØ§Ù‡ÙŠØ© Ø§Ù„Ù†ÙØ³ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ù…Ù…Ø§ ÙŠØ³ØªØ¯Ø¹ÙŠ Ø®Ø·Ø© Ø¯Ø¹Ù… ØªØ¯Ø±ÙŠØ¬ÙŠØ© ÙˆÙ…Ø±ÙƒØ²Ø©."
    elif prediction == 1:
        severity_text = "ğŸŸ¡ Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙˆØ³Ø·"
        intro = "Ù‡Ù†Ø§Ùƒ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„ØªÙˆØ§Ø²Ù† Ø§Ù„Ù†ÙØ³ÙŠØŒ ÙˆÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡Ø§ Ø¨Ø®Ø·Ø© Ø³Ù„ÙˆÙƒÙŠØ© Ù…Ù†Ø¸Ù…Ø©."
    else:
        severity_text = "ğŸŸ¢ Ù…Ø³ØªÙˆÙ‰ Ø¬ÙŠØ¯"
        intro = "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø±ÙØ§Ù‡ÙŠØ© Ù„Ø¯ÙŠÙƒ Ø¬ÙŠØ¯ Ù†Ø³Ø¨ÙŠØ§Ù‹ØŒ ÙˆØ³Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰ ØªØ¹Ø²ÙŠØ² Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± ÙˆØ§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©."

    plan += f"### {severity_text}\n\n{intro}\n\n"

    dimensions = {
        "Ø§Ù„Ù…Ø²Ø§Ø¬": q1,
        "Ø§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡": q2,
        "Ø§Ù„Ø·Ø§Ù‚Ø©": q3,
        "Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ù…Ù†ØªØ¹Ø´": q4,
        "Ø§Ù„Ù…Ø¹Ù†Ù‰": q5
    }

    weak_areas = [k for k, v in dimensions.items() if v <= 2]

    if weak_areas:
        plan += "### ğŸ” Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¯Ø¹Ù…Ø§Ù‹ Ø®Ø§ØµØ§Ù‹:\n"
        for area in weak_areas:
            plan += f"- {area}\n"
        plan += "\n"

    plan += "## ğŸ“… Ø®Ø·Ø© ØªØ­Ø³ÙŠÙ† Ù„Ù…Ø¯Ø© 6 Ø£Ø³Ø§Ø¨ÙŠØ¹\n\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1: Ø§Ù„ØªØ«Ø¨ÙŠØª ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±\n"
    plan += "- ØªÙ†Ø¸ÙŠÙ… Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ù†ÙˆÙ… ÙˆØ§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸\n"
    plan += "- Ù…Ø´ÙŠ Ø®ÙÙŠÙ 20 Ø¯Ù‚ÙŠÙ‚Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹\n"
    plan += "- ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ø¹Ø± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\n\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 2: ØªÙ†Ø´ÙŠØ· Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ\n"
    plan += "- Ø¬Ø¯ÙˆÙ„Ø© Ù†Ø´Ø§Ø· Ù…Ù…ØªØ¹ Ù…Ø±ØªÙŠÙ† Ø£Ø³Ø¨ÙˆØ¹ÙŠØ§Ù‹\n"
    plan += "- ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø²Ù„Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©\n"
    plan += "- ØªÙ…Ø§Ø±ÙŠÙ† ØªÙ†ÙØ³ ÙŠÙˆÙ…ÙŠØ© 5 Ø¯Ù‚Ø§Ø¦Ù‚\n\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ø©\n"
    if q3 <= 2:
        plan += "- Ø§Ù„ØªØ¹Ø±Ø¶ Ù„Ø¶ÙˆØ¡ Ø§Ù„Ø´Ù…Ø³ ØµØ¨Ø§Ø­Ø§Ù‹\n"
        plan += "- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù…Ù‡Ø§Ù… Ø¥Ù„Ù‰ Ø®Ø·ÙˆØ§Øª ØµØºÙŠØ±Ø©\n"
    plan += "- ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ù‡Ø± Ø§Ù„Ø²Ø§Ø¦Ø¯\n\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 4: ØªØ­Ø³ÙŠÙ† Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†ÙˆÙ…\n"
    if sleep < 6:
        plan += "- Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ… Ø¨Ø³Ø§Ø¹Ø©\n"
        plan += "- ØªØ«Ø¨ÙŠØª Ø·Ù‚ÙˆØ³ Ù†ÙˆÙ… Ø«Ø§Ø¨ØªØ©\n"
    else:
        plan += "- Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù†ØªØ¸Ø§Ù… Ø§Ù„Ù†ÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ\n"
    plan += "\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 5: ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù…Ø¹Ù†Ù‰ ÙˆØ§Ù„Ù‡Ø¯Ù\n"
    if q5 <= 2:
        plan += "- ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø¨Ø³ÙŠØ·\n"
        plan += "- ØªØ¬Ø±Ø¨Ø© Ù†Ø´Ø§Ø· ØªØ·ÙˆØ¹ÙŠ Ø£Ùˆ ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø©\n"
    else:
        plan += "- Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆÙˆØ¶Ø¹ Ø®Ø·Ø© Ù‚ØµÙŠØ±Ø© Ø§Ù„Ù…Ø¯Ù‰\n"
    plan += "\n"

    plan += "### Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 6: Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª\n"
    plan += "- Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙ‚Ø¯Ù…\n"
    plan += "- ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± ÙØ§Ø¦Ø¯Ø©\n"
    plan += "- Ù…ÙƒØ§ÙØ£Ø© Ø°Ø§ØªÙŠØ© Ø±Ù…Ø²ÙŠØ©\n\n"

    if prediction == 2:
        plan += "âš ï¸ ÙŠÙÙˆØµÙ‰ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ù…Ø®ØªØµ Ù†ÙØ³ÙŠ Ø¥Ø°Ø§ Ø§Ø³ØªÙ…Ø±Øª Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø£Ùˆ Ø£Ø«Ø±Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ.\n\n"

    plan += "> Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø© Ø¯Ø§Ø¹Ù…Ø© ÙˆÙ„Ø§ ÙŠÙØ¹Ø¯ ØªØ´Ø®ÙŠØµØ§Ù‹ Ø·Ø¨ÙŠØ§Ù‹."

    return plan


# ----------------------------
# 3ï¸âƒ£ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
# ----------------------------
st.title("ğŸ§  ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø±ÙØ§Ù‡ÙŠØ© Ø§Ù„Ù†ÙØ³ÙŠØ© - WHO-5")
st.markdown("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø´Ø®ØµÙŠ:")

q1 = st.slider("1ï¸âƒ£ Ø´Ø¹Ø±Øª Ø¨Ù…Ø²Ø§Ø¬ Ø¬ÙŠØ¯", 0, 5, 2)
q2 = st.slider("2ï¸âƒ£ Ø´Ø¹Ø±Øª Ø¨Ø§Ù„Ù‡Ø¯ÙˆØ¡ ÙˆØ§Ù„Ø§Ø³ØªØ±Ø®Ø§Ø¡", 0, 5, 2)
q3 = st.slider("3ï¸âƒ£ Ø´Ø¹Ø±Øª Ø¨Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØ§Ù„Ø­ÙŠÙˆÙŠØ©", 0, 5, 2)
q4 = st.slider("4ï¸âƒ£ Ø§Ø³ØªÙŠÙ‚Ø¸Øª Ù†Ø´ÙŠØ·Ø§Ù‹ ÙˆÙ…Ù†ØªØ¹Ø´Ø§Ù‹", 0, 5, 2)
q5 = st.slider("5ï¸âƒ£ ÙƒØ§Ù† Ù„Ø­ÙŠØ§ØªÙŠ Ù…Ø¹Ù†Ù‰", 0, 5, 2)

sleep = st.slider("Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù†ÙˆÙ…", 4, 10, 7)
activity = st.slider("Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ (1 Ù…Ù†Ø®ÙØ¶ - 5 Ø¹Ø§Ù„ÙŠ)", 1, 5, 3)

# ----------------------------
# 4ï¸âƒ£ Ø§Ù„ØªØ­Ù„ÙŠÙ„
# ----------------------------
if st.button("Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„"):

    user_input = np.array([[q1, q2, q3, q4, q5, sleep, activity]])
    prediction = model.predict(user_input)[0]
    probabilities = model.predict_proba(user_input)[0]

    st.subheader("ğŸ“ˆ Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ")
    st.write(f"Ù…Ù†Ø®ÙØ¶: {probabilities[0]*100:.1f}%")
    st.write(f"Ù…ØªÙˆØ³Ø·: {probabilities[1]*100:.1f}%")
    st.write(f"Ù…Ø±ØªÙØ¹: {probabilities[2]*100:.1f}%")

    report = generate_plan(q1, q2, q3, q4, q5, sleep, activity, prediction)

    st.markdown(report)

