import streamlit as st
import numpy as np
from sklearn.ensemble import RandomForestClassifier

# =====================================
# 1๏ธโฃ ุชุฏุฑูุจ ูููุฐุฌ ุชุนูู ุขูุฉ
# =====================================

@st.cache_data
def train_model():
    np.random.seed(42)
    n = 3000

    Q = np.random.randint(0, 6, (n, 5))
    sleep = np.random.randint(4, 11, n)
    activity = np.random.randint(1, 6, n)

    total = Q.sum(axis=1)

    risk = []
    for t in total:
        if t <= 10:
            risk.append(2)  # ูุฑุชูุน
        elif t <= 17:
            risk.append(1)  # ูุชูุณุท
        else:
            risk.append(0)  # ููุฎูุถ

    X = np.column_stack((Q, sleep, activity))
    y = np.array(risk)

    model = RandomForestClassifier(n_estimators=250, random_state=42)
    model.fit(X, y)

    return model

model = train_model()

# =====================================
# 2๏ธโฃ ูุญุฑู ุงูุชุญููู ุงูููุณู ุงููุชูุฏู
# =====================================

def generate_plan(q1, q2, q3, q4, q5, sleep, activity, prediction):

    scores = np.array([q1, q2, q3, q4, q5])
    labels = ["ุงููุฒุงุฌ", "ุงูุงุณุชุฑุฎุงุก", "ุงูุทุงูุฉ", "ุงูููู ุงูููุชุนุด", "ุงููุนูู"]

    total = scores.sum()
    low_count = np.sum(scores <= 2)
    imbalance = np.std(scores)

    # ูุคุดุฑ ุงูุงุณุชูุฒุงู ุงูุญููู
    bio_strain = 0
    if sleep <= 5:
        bio_strain += 1
    if q3 <= 2:
        bio_strain += 1
    if activity <= 2:
        bio_strain += 1

    # ูุคุดุฑ ุงูุฎุทูุฑุฉ ุงููุฑูุจ
    composite_risk = (
        (20 - total) * 0.4 +
        (low_count * 2) +
        (bio_strain * 2)
    )

    # ุชุญุฏูุฏ ุงูููุท
    if bio_strain >= 2:
        profile = "ุงุณุชูุฒุงู ุฌุณุฏู"
        strategy = "ุฅุนุงุฏุฉ ุถุจุท ุจููููุฌูุฉ ุงูุฌุณู ุฃููุงู"
    elif low_count >= 3:
        profile = "ุงูุฎูุงุถ ููุณู ุดุงูู"
        strategy = "ุชุฏุฎู ุชุฏุฑูุฌู ูุชุนุฏุฏ ุงููุญุงูุฑ"
    elif imbalance >= 1.5:
        profile = "ุงุฎุชูุงู ููุณู ุบูุฑ ูุชูุงุฒู"
        strategy = "ุชุตุญูุญ ุงูุจุนุฏ ุงูุฃุถุนู ุฃููุงู"
    elif q5 <= 2:
        profile = "ุถุนู ูู ุงููุนูู ูุงูุฏุงูุนูุฉ"
        strategy = "ุฅุนุงุฏุฉ ุจูุงุก ุงููุฏู ุงูุดุฎุตู"
    elif q1 <= 2:
        profile = "ุงูุฎูุงุถ ูุฒุงุฌู"
        strategy = "ุชุฏุฎู ูุนุฑูู ุณูููู"
    else:
        profile = "ุงุณุชูุฑุงุฑ ูุณุจู"
        strategy = "ุชุนุฒูุฒ ูุงุณุชุฏุงูุฉ"

    # ุชุญุฏูุฏ ูุณุชูู ุงูุดุฏุฉ
    if composite_risk >= 15:
        level = "ูุฑุชูุน"
    elif composite_risk >= 8:
        level = "ูุชูุณุท"
    else:
        level = "ููุฎูุถ"

    # ุจูุงุก ุงูุชูุฑูุฑ
    report = "## ๐ง ุงูุชุญููู ุงูููุณู ุงููุชูุฏู\n\n"
    report += f"### ุงูููุท ุงูููุชุดู: {profile}\n"
    report += f"๐ฏ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุนุงูุฉ: {strategy}\n\n"

    report += "### ๐ ุงููุคุดุฑุงุช ุงูุชุญููููุฉ:\n"
    report += f"- ุงููุฌููุน ุงูููู: {total} / 25\n"
    report += f"- ุนุฏุฏ ุงูุฃุจุนุงุฏ ุงูููุฎูุถุฉ: {low_count}\n"
    report += f"- ูุคุดุฑ ุงูุงุฎุชูุงู: {imbalance:.2f}\n"
    report += f"- ูุคุดุฑ ุงูุงุณุชูุฒุงู ุงูุญููู: {bio_strain}\n"
    report += f"- ุฏุฑุฌุฉ ุงูุฎุทูุฑุฉ ุงููุฑูุจุฉ: {composite_risk:.2f}\n"
    report += f"- ูุณุชูู ุงูุดุฏุฉ: {level}\n\n"

    # ุงูุฎุทุท ุญุณุจ ุงูููุท
    if profile == "ุงุณุชูุฒุงู ุฌุณุฏู":
        report += """
## ๐ค ุฎุทุฉ ุงูุงุณุชุดูุงุก ุงูุจููููุฌู (6 ุฃุณุงุจูุน)

ุงูุฃุณุจูุน 1-2:
- ููู ุซุงุจุช ููููุงู
- ุชูููู ุงูููุจูุงุช
- ุดุฑุจ 2 ูุชุฑ ูุงุก

ุงูุฃุณุจูุน 3-4:
- ูุดู 30 ุฏูููุฉ
- ุชุนุฑูุถ ุงูุฌุณู ููุดูุณ ุตุจุงุญุงู

ุงูุฃุณุจูุน 5-6:
- ุชูุงุฑูู ููุงููุฉ ุฎูููุฉ
- ุชูููู ุชุญุณู ุงูุทุงูุฉ
"""

    elif profile == "ุงูุฎูุงุถ ููุณู ุดุงูู":
        report += """
## ๐ ุฎุทุฉ ุฏุนู ููุณู ุชุฏุฑูุฌู

ุงูุฃุณุจูุน 1:
- ุชุซุจูุช ุงูููู
- ุชูููู ุงูุนุฒูุฉ

ุงูุฃุณุจูุน 2:
- ูุดุงุท ููุชุน ูุฌุฏูู

ุงูุฃุณุจูุน 3:
- ุฃูุฏุงู ุตุบูุฑุฉ ููููุฉ

ุงูุฃุณุจูุน 4-6:
- ูุฑุงุฌุนุฉ ุงูุฃููุงุฑ ุงูุณูุจูุฉ
- ุฏุนู ุงุฌุชูุงุนู
โ๏ธ ููุตู ุจุงุณุชุดุงุฑุฉ ูุฎุชุต.
"""

    elif profile == "ุงุฎุชูุงู ููุณู ุบูุฑ ูุชูุงุฒู":
        weakest = labels[np.argmin(scores)]
        report += f"""
## ๐ฏ ุฎุทุฉ ุชุตุญูุญ ุจูุนุฏ {weakest}

- ุชูุงุฑูู ูุฎุตุตุฉ ููุฐุง ุงูุฌุงูุจ
- ููุงุณ ุฃุณุจูุนู ููุชูุฏู
- ุนุฏู ุชุบููุฑ ุจุงูู ุงูุนุงุฏุงุช ุญุงููุงู
"""

    elif profile == "ุถุนู ูู ุงููุนูู ูุงูุฏุงูุนูุฉ":
        report += """
## ๐ฑ ุฅุนุงุฏุฉ ุจูุงุก ุงููุนูู

- ูุชุงุจุฉ ุงูููู ุงูุดุฎุตูุฉ
- ุชุญุฏูุฏ ูุฏู ุฃุณุจูุนู ุจุณูุท
- ุชุฌุฑุจุฉ ูุดุงุท ุชุทูุนู
"""

    elif profile == "ุงูุฎูุงุถ ูุฒุงุฌู":
        report += """
## ๐ค ุชุญุณูู ุงููุฒุงุฌ

- ุชูุฑูู ุงูุงูุชูุงู ููููุงู
- ูุดุงุท ุงุฌุชูุงุนู ุฃุณุจูุนู
- ุฅุนุงุฏุฉ ููููุฉ ุงูุฃููุงุฑ ุงูุณูุจูุฉ ูุชุงุจุฉู
"""

    else:
        report += """
## ๐ฟ ุฎุทุฉ ุงุณุชุฏุงูุฉ

- ุงูุญูุงุธ ุนูู ุงูุนุงุฏุงุช ุงูุญุงููุฉ
- ูุฑุงุฌุนุฉ ุดูุฑูุฉ
- ุชุทููุฑ ูุฏู ุทููู ุงููุฏู
"""

    report += "\n\n> ูุฐุง ุงููุธุงู ุฃุฏุงุฉ ุฏุนู ุฐุงุชู ููุง ููุซู ุชุดุฎูุตุงู ุทุจูุงู."

    return report


# =====================================
# 3๏ธโฃ ูุงุฌูุฉ ุงููุณุชุฎุฏู
# =====================================

st.title("๐ง ุชูููู ุงูุฑูุงููุฉ ุงูููุณูุฉ WHO-5")

st.markdown("""
## ๐ ุชุนูููุงุช ุงูุงุฎุชุจุงุฑ

- ุฃุฌุจ ุจูุงุกู ุนูู ุขุฎุฑ ุฃุณุจูุนูู
- ูุง ุชูุฌุฏ ุฅุฌุงุจุงุช ุตุญูุญุฉ ุฃู ุฎุงุทุฆุฉ
- ุงุฎุชุฑ ูุง ูุนูุณ ุดุนูุฑู ุงููุนูู
- ุงููููุงุณ ูู 0 ุฅูู 5:

0 = ุฃุจุฏุงู  
1 = ูุงุฏุฑุงู  
2 = ุฃุญูุงูุงู  
3 = ุบุงูุจุงู  
4 = ูุนุธู ุงูููุช  
5 = ุทูุงู ุงูููุช  

โ๏ธ ูุฐุง ูุญุต ุฃููู ูููุณ ุชุดุฎูุตุงู ุทุจูุงู.
""")

q1 = st.slider("1๏ธโฃ ุดุนุฑุช ุจูุฒุงุฌ ุฌูุฏ", 0, 5, 2)
q2 = st.slider("2๏ธโฃ ุดุนุฑุช ุจุงููุฏูุก ูุงูุงุณุชุฑุฎุงุก", 0, 5, 2)
q3 = st.slider("3๏ธโฃ ุดุนุฑุช ุจุงููุดุงุท ูุงูุญูููุฉ", 0, 5, 2)
q4 = st.slider("4๏ธโฃ ุงุณุชููุธุช ูุดูุทุงู ูููุชุนุดุงู", 0, 5, 2)
q5 = st.slider("5๏ธโฃ ูุงู ูุญูุงุชู ูุนูู", 0, 5, 2)

sleep = st.slider("ุนุฏุฏ ุณุงุนุงุช ุงูููู", 4, 10, 7)
activity = st.slider("ูุณุชูู ุงููุดุงุท ุงูุจุฏูู (1 ููุฎูุถ - 5 ุนุงูู)", 1, 5, 3)

# =====================================
# 4๏ธโฃ ุงูุชุญููู
# =====================================

if st.button("ุงุญุตู ุนูู ุงูุฎุทุฉ ุงูุชุญุณูููุฉ"):

    user_input = np.array([[q1, q2, q3, q4, q5, sleep, activity]])
    prediction = model.predict(user_input)[0]
    probabilities = model.predict_proba(user_input)[0]

    st.subheader("๐ ุงุญุชูุงูุงุช ุงูุชุตููู:")
    st.write(f"ููุฎูุถ: {probabilities[0]*100:.1f}%")
    st.write(f"ูุชูุณุท: {probabilities[1]*100:.1f}%")
    st.write(f"ูุฑุชูุน: {probabilities[2]*100:.1f}%")

    report = generate_plan(q1, q2, q3, q4, q5, sleep, activity, prediction)
    st.markdown(report)
