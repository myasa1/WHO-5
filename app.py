import streamlit as st
import numpy as np
from sklearn.ensemble import RandomForestClassifier

# =====================================
# 1๏ธโฃ ุชุฏุฑูุจ ูููุฐุฌ ุชุนูู ุขูุฉ
# =====================================

@st.cache_data
def train_model():
    np.random.seed(42)
    n = 3000

    Q = np.random.randint(0, 6, (n, 5))
    sleep = np.random.randint(4, 11, n)
    activity = np.random.randint(1, 6, n)

    total = Q.sum(axis=1)

    risk = []
    for t in total:
        if t <= 10:
            risk.append(2)  # ุฎุทุฑ
        elif t <= 17:
            risk.append(1)  # ูุชูุณุท
        else:
            risk.append(0)  # ุทุจูุนู

    X = np.column_stack((Q, sleep, activity))
    y = np.array(risk)

    model = RandomForestClassifier(n_estimators=250, random_state=42)
    model.fit(X, y)

    return model

model = train_model()

# =====================================
# 2๏ธโฃ ูุญุฑู ุงูุชุญููู ุงูููุณู (ุฏุงุฎูู)
# =====================================

def generate_plan(q1, q2, q3, q4, q5, sleep, activity):

    scores = np.array([q1, q2, q3, q4, q5])
    labels = ["ุงููุฒุงุฌ", "ุงูุงุณุชุฑุฎุงุก", "ุงูุทุงูุฉ", "ุงูููู ุงูููุชุนุด", "ุงููุนูู"]

    total = scores.sum()
    low_count = np.sum(scores <= 2)
    imbalance = np.std(scores)

    bio_strain = 0
    if sleep <= 5:
        bio_strain += 1
    if q3 <= 2:
        bio_strain += 1
    if activity <= 2:
        bio_strain += 1

    composite_risk = (
        (20 - total) * 0.4 +
        (low_count * 2) +
        (bio_strain * 2)
    )

    # ุชุญุฏูุฏ ุงูููุท ุฏุงุฎููุงู
    if bio_strain >= 2:
        profile = "ุงุณุชูุฒุงู ุฌุณุฏู"
    elif low_count >= 3:
        profile = "ุงูุฎูุงุถ ููุณู ุดุงูู"
    elif imbalance >= 1.5:
        profile = "ุงุฎุชูุงู ุบูุฑ ูุชูุงุฒู"
    elif q5 <= 2:
        profile = "ุถุนู ูู ุงููุนูู"
    elif q1 <= 2:
        profile = "ุงูุฎูุงุถ ูุฒุงุฌู"
    else:
        profile = "ุงุณุชูุฑุงุฑ ูุณุจู"

    report = ""

    # ุงูุฎุทุท ุญุณุจ ุงูููุท
    if profile == "ุงุณุชูุฒุงู ุฌุณุฏู":
        report += """
## ๐ค ุฎุทุฉ ุงูุงุณุชุดูุงุก (6 ุฃุณุงุจูุน)

- ุชุซุจูุช ููุนุฏ ููู ูููู
- ุชูููู ุงูููุจูุงุช ูุณุงุกู
- ุดุฑุจ ูููุฉ ูุงููุฉ ูู ุงููุงุก
- ูุดู ุฎููู 30 ุฏูููุฉ
- ุงูุชุนุฑุถ ูุถูุก ุงูุดูุณ ุตุจุงุญุงู
"""

    elif profile == "ุงูุฎูุงุถ ููุณู ุดุงูู":
        report += """
## ๐ ุฎุทุฉ ุฏุนู ููุณู ุชุฏุฑูุฌู

- ุชูุธูู ุงูููู ุฃููุงู
- ุชูููู ุงูุนุฒูุฉ ุงูุงุฌุชูุงุนูุฉ
- ูุดุงุท ููุชุน ูุฌุฏูู ุฃุณุจูุนูุงู
- ุฃูุฏุงู ุตุบูุฑุฉ ููููุฉ
โ๏ธ ูููุถูู ุงุณุชุดุงุฑุฉ ูุฎุชุต ุฅุฐุง ุงุณุชูุฑุช ุงูุฃุนุฑุงุถ.
"""

    elif profile == "ุงุฎุชูุงู ุบูุฑ ูุชูุงุฒู":
        weakest = labels[np.argmin(scores)]
        report += f"""
## ๐ฏ ุฎุทุฉ ุชุนุฒูุฒ ุจูุนุฏ {weakest}

- ุชูุงุฑูู ูุฎุตุตุฉ ููุฐุง ุงูุฌุงูุจ
- ููุงุณ ุงูุชุญุณู ุฃุณุจูุนูุงู
- ุนุฏู ุงูุถุบุท ุนูู ููุณู ูู ุจููุฉ ุงูุฌูุงูุจ ุญุงููุงู
"""

    elif profile == "ุถุนู ูู ุงููุนูู":
        report += """
## ๐ฑ ุฅุนุงุฏุฉ ุจูุงุก ุงููุนูู

- ูุชุงุจุฉ ุงูููู ุงูุดุฎุตูุฉ
- ุชุญุฏูุฏ ูุฏู ุฃุณุจูุนู ุจุณูุท
- ุชุฌุฑุจุฉ ูุดุงุท ุฌุฏูุฏ ุฃู ุชุทูุนู
"""

    elif profile == "ุงูุฎูุงุถ ูุฒุงุฌู":
        report += """
## ๐ค ุชุญุณูู ุงููุฒุงุฌ

- ุชูุฑูู ุงูุงูุชูุงู ููููุงู
- ุฒูุงุฏุฉ ุงูุชูุงุนู ุงูุงุฌุชูุงุนู
- ูุชุงุจุฉ ุงูุฃููุงุฑ ุงูุณูุจูุฉ ูุฅุนุงุฏุฉ ุตูุงุบุชูุง
"""

    else:
        report += """
## ๐ฟ ุฎุทุฉ ุงุณุชุฏุงูุฉ

- ุงูุญูุงุธ ุนูู ุงูุนุงุฏุงุช ุงูุญุงููุฉ
- ุชุญุณูู ุงูููู ูุงููุดุงุท ุชุฏุฑูุฌูุงู
- ูุฑุงุฌุนุฉ ุดูุฑูุฉ ูุญุงูุชู ุงูููุณูุฉ
"""

    report += "\n\n> ูุฐุง ุงูุชูููู ุฃุฏุงุฉ ุฏุนู ุฐุงุชู ููุง ููุนุฏ ุชุดุฎูุตุงู ุทุจูุงู."

    return report


# =====================================
# 3๏ธโฃ ูุงุฌูุฉ ุงููุณุชุฎุฏู
# =====================================

st.title("๐ง ุชูููู ุงูุฑูุงููุฉ ุงูููุณูุฉ WHO-5")

st.markdown("""
## ๐ ุชุนูููุงุช ุงูุงุฎุชุจุงุฑ

- ุฃุฌุจ ุจูุงุกู ุนูู ุขุฎุฑ ุฃุณุจูุนูู
- ุงุฎุชุฑ ุงูุฅุฌุงุจุฉ ุงูุชู ุชุนุจูุฑ ุนู ุดุนูุฑู ุงูุญูููู
- ุงููููุงุณ ูู 0 ุฅูู 5

0 = ุฃุจุฏุงู  
1 = ูุงุฏุฑุงู  
2 = ุฃุญูุงูุงู  
3 = ุบุงูุจุงู  
4 = ูุนุธู ุงูููุช  
5 = ุทูุงู ุงูููุช  

โ๏ธ ูุฐุง ูุญุต ุฃููู ูููุณ ุชุดุฎูุตุงู ุทุจูุงู.
""")

q1 = st.slider("1๏ธโฃ ุดุนุฑุช ุจูุฒุงุฌ ุฌูุฏ", 0, 5, 2)
q2 = st.slider("2๏ธโฃ ุดุนุฑุช ุจุงููุฏูุก ูุงูุงุณุชุฑุฎุงุก", 0, 5, 2)
q3 = st.slider("3๏ธโฃ ุดุนุฑุช ุจุงููุดุงุท ูุงูุญูููุฉ", 0, 5, 2)
q4 = st.slider("4๏ธโฃ ุงุณุชููุธุช ูุดูุทุงู ูููุชุนุดุงู", 0, 5, 2)
q5 = st.slider("5๏ธโฃ ูุงู ูุญูุงุชู ูุนูู", 0, 5, 2)

sleep = st.slider("ุนุฏุฏ ุณุงุนุงุช ุงูููู", 4, 10, 7)
activity = st.slider("ูุณุชูู ุงููุดุงุท ุงูุจุฏูู (1 ููุฎูุถ - 5 ุนุงูู)", 1, 5, 3)

# =====================================
# 4๏ธโฃ ุงูุชุญููู ุงูููุงุฆู (ุจุฏูู ุฃุฑูุงู)
# =====================================

if st.button("ุนุฑุถ ุงููุชูุฌุฉ"):

    user_input = np.array([[q1, q2, q3, q4, q5, sleep, activity]])
    prediction = model.predict(user_input)[0]

    # ุนุฑุถ ุชุตููู ูุจุณุท ููุท
    if prediction == 2:
        status = "๐ด ุฎุทุฑ"
        message = "ุชุดูุฑ ุฅุฌุงุจุงุชู ุฅูู ูุฌูุฏ ุถุบุท ููุณู ูุฑุชูุน ุญุงููุงู."
    elif prediction == 1:
        status = "๐ก ูุชูุณุท"
        message = "ููุงู ุจุนุถ ุงููุคุดุฑุงุช ุงูุชู ุชุณุชุญู ุงูุงูุชุจุงู ูุงูุชุญุณูู."
    else:
        status = "๐ข ุทุจูุนู"
        message = "ูุณุชูู ุงูุฑูุงููุฉ ูุฏูู ุถูู ุงููุทุงู ุงูุทุจูุนู."

    st.subheader("๐ ุชุตููู ุงูุญุงูุฉ:")
    st.markdown(f"## {status}")
    st.write(message)

    # ุนุฑุถ ุงูุฎุทุฉ ููุท
    report = generate_plan(q1, q2, q3, q4, q5, sleep, activity)
    st.markdown(report)


